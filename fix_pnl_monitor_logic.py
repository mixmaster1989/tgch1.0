#!/usr/bin/env python3
"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ª–æ–≥–∏–∫–∏ PnLMonitor - —É–±—Ä–∞—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –≤—Å–µ–π –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏ –ø—Ä–∏ –æ–±—â–µ–º –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–º PnL
"""

def fix_pnl_monitor_logic():
    # –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª
    with open('pnl_monitor.py', 'r', encoding='utf-8') as f:
        content = f.read()
    
    # –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ–º –º–µ—Ç–æ–¥ check_portfolio_balance
    old_method = '''            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–Ω–æ –ª–∏ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞—Ç—å
            if total_pnl < 0 and not self.portfolio_balancer.allow_negative_pnl_rebalance:
                logger.warning(f"üö´ –ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞: –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π PnL ${total_pnl:.4f}")
                self.portfolio_balancer.blocked_rebalances += 1
                
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ
                block_message = (
                    "<b>üö´ –ë–ê–õ–ê–ù–°–ò–†–û–í–ö–ê –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù–ê</b>\\n\\n"
                    f"üìâ –û–±—â–∏–π PnL: ${total_pnl:.4f}\\n"
                    f"üõ°Ô∏è –ü—Ä–∏—á–∏–Ω–∞: –ó–∞—â–∏—Ç–∞ –æ—Ç —É–±—ã—Ç–∫–æ–≤\\n"
                    f"‚è∞ –í—Ä–µ–º—è: {datetime.now().strftime('%H:%M:%S')}\\n\\n"
                    "üí° –ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ –±—É–¥–µ—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∞ –ø—Ä–∏ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–º PnL"
                )
                self.send_telegram_message(block_message)
                return'''
    
    new_method = '''            # üî• –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê: –ù–µ –±–ª–æ–∫–∏—Ä—É–µ–º –≤—Å—é –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫—É –ø—Ä–∏ –æ–±—â–µ–º –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–º PnL
            # –¢–µ–ø–µ—Ä—å PortfolioBalancer —Å–∞–º —Ä–µ—à–∞–µ—Ç —á—Ç–æ –º–æ–∂–Ω–æ –ø—Ä–æ–¥–∞–≤–∞—Ç—å/–ø–æ–∫—É–ø–∞—Ç—å –Ω–∞ –æ—Å–Ω–æ–≤–µ PnL –∫–∞–∂–¥–æ–≥–æ –∞–∫—Ç–∏–≤–∞
            logger.info(f"üí∞ –û–±—â–∏–π PnL –ø–æ—Ä—Ç—Ñ–µ–ª—è: ${total_pnl:.4f} - –ø–µ—Ä–µ–¥–∞–µ–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ PortfolioBalancer")
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (–Ω–µ –±–ª–æ–∫–∏—Ä—É—é—â–µ–µ)
            if total_pnl < 0:
                info_message = (
                    "<b>‚ÑπÔ∏è –ë–ê–õ–ê–ù–°–ò–†–û–í–ö–ê –° –û–¢–†–ò–¶–ê–¢–ï–õ–¨–ù–´–ú PnL</b>\\n\\n"
                    f"üìâ –û–±—â–∏–π PnL: ${total_pnl:.4f}\\n"
                    f"üõ°Ô∏è –ó–∞—â–∏—Ç–∞: –ü—Ä–æ–¥–∞–∂–∞ —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–æ–≤ –≤ –ø–ª—é—Å–µ\\n"
                    f"‚è∞ –í—Ä–µ–º—è: {datetime.now().strftime('%H:%M:%S')}\\n\\n"
                    "üí° PortfolioBalancer –ø—Ä–æ–≤–µ—Ä–∏—Ç PnL –∫–∞–∂–¥–æ–≥–æ –∞–∫—Ç–∏–≤–∞ –æ—Ç–¥–µ–ª—å–Ω–æ"
                )
                self.send_telegram_message(info_message)'''
    
    # –ó–∞–º–µ–Ω—è–µ–º –º–µ—Ç–æ–¥
    content = content.replace(old_method, new_method)
    
    # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ
    with open('pnl_monitor.py', 'w', encoding='utf-8') as f:
        f.write(content)
    
    print("‚úÖ pnl_monitor.py –∏—Å–ø—Ä–∞–≤–ª–µ–Ω - —É–±—Ä–∞–Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –≤—Å–µ–π –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏ –ø—Ä–∏ –æ–±—â–µ–º –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–º PnL")

if __name__ == "__main__":
    fix_pnl_monitor_logic()
